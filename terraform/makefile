NAMESPACE=three-tier-app

include .env.postgres
export

.PHONY: start addons init validate plan apply-plan run test delete all

start:
	@echo "ğŸš€ Starting Minikube..."
	minikube start --driver=docker

addons:
	@echo "ğŸ”§ Enabling Minikube addons..."
	minikube addons enable ingress
	minikube addons enable default-storageclass

init:
	@echo "ğŸ“¦ Initializing Terraform..."
	terraform init

validate:
	@echo "ğŸ” Validating Terraform..."
	terraform validate

plan:
	@echo "âš¡ Generating Terraform plan..."
	terraform plan -out=k8s.plan \
		-var="postgres_user=$(POSTGRES_USER)" \
		-var="postgres_password=$(POSTGRES_PASSWORD)" \
		-var="postgres_db=$(POSTGRES_DB)"

apply-plan:
	terraform apply k8s.plan

apply:
	@echo "âš¡ Applying Terraform directly..."
	terraform apply -auto-approve \
		-var="postgres_user=$(POSTGRES_USER)" \
		-var="postgres_password=$(POSTGRES_PASSWORD)" \
		-var="postgres_db=$(POSTGRES_DB)"

run: start addons init validate apply
	@echo "âœ… Infrastructure deployed!"

test:
	@echo "ğŸ§ª Testing deployment..."
	kubectl get pods -n $(NAMESPACE)
	kubectl get pvc -n $(NAMESPACE)

delete:
	@echo "ğŸ’¥ Deleting Minikube..."
	minikube delete --all

all: run test
